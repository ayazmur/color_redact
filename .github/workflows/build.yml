name: Build EXE

on:
  push:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Display directory structure
      run: |
        echo "Содержимое репозитория:"
        dir

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt5 opencv-python python-docx Pillow lxml numpy pyinstaller

    - name: Build EXE with PyInstaller
      run: |
        echo "Сборка EXE..."
        pyinstaller --name=RedShapeEditor --windowed --onefile --clean --noconfirm ^
          --add-data="core;core" ^
          --add-data="ui;ui" ^
          --add-data="utils;utils" ^
          --hidden-import=docx.oxml ^
          --hidden-import=docx.opc.constants ^
          --hidden-import=docx.image ^
          --hidden-import=docx.oxml.shape ^
          --hidden-import=docx.oxml.ns ^
          --hidden-import=docx.opc.phys_pkg ^
          --hidden-import=PIL._imaging ^
          --hidden-import=cv2 ^
          --hidden-import=lxml.etree ^
          --hidden-import=lxml._elementpath ^
          main.py

    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: RedShapeEditor-Windows
        path: dist/RedShapeEditor.exe
        retention-days: 30
        compression-level: 9