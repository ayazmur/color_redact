name: Create Release with EXE

on:
  push:
    branches: [ release ]
  release:
    types: [ published ]

env:
  PYTHON_VERSION: '3.9'

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt5==5.15.10 opencv-python==4.8.1.78 python-docx==1.1.0 Pillow==10.0.1 lxml==4.9.3 numpy==1.24.3 pyinstaller==6.16.0

    - name: Build EXE
      run: |
        python build_ci.py

    - name: Create Release and Upload EXE
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/RedShapeEditor.exe
        tag_name: ${{ github.event.release.tag_name || 'v1.0.0' }}
        name: ${{ github.event.release.name || 'Red Shape Editor' }}
        body: |
          # Red Shape Editor
          
          ## Automated Release
          
          This release contains the ready-to-use Windows executable.
          
          ### Download
          Click on **RedShapeEditor.exe** above to download the application.
          
          ### How to Use
          1. Download and run `RedShapeEditor.exe`
          2. Click "Open Word Document" to select your .docx file
          3. Select areas with colored shapes
          4. Preview changes and save the result
          
          ###  Windows Security Notice
          Windows may show a security warning since this is an unsigned application. 
          Click "More info" â†’ "Run anyway" to proceed.
          
          **Source Code:** https://github.com/ayazmur/color_redact
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Commit:** ${{ github.sha }}
        draft: false
        prerelease: false